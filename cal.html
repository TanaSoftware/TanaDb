<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title></title>
    <link href="css/cal.css" rel="stylesheet" />
    <link href="css/selectize.css" rel="stylesheet" />
    <link href='https://use.fontawesome.com/releases/v5.0.6/css/all.css' rel='stylesheet'>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" rel='stylesheet' />
    <link href="css/genaral.css" rel="stylesheet" />
    <script src="js/cal.js"></script>
    <script src="js/moment.js"></script>

    <script src="js/jquery-1.9.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.he.min.js"></script>
    <script src="js/selectize.js"></script>
    <script src="js/global.js"></script>
    <style>
        .selectize-input {
            direction: rtl !important;
            text-align: right !important;
        }

        .selectize-dropdown {
            direction: rtl !important;
            text-align: right !important;
        }

        .tooltip-inner {
            background-color: #f00 !important;
        }



        @media only screen and (max-width: 760px) {

            .fc-content {
                padding: 5px;
            }



            .fc-time-grid .fc-slats td {
                height: 3.5em;
            }
        }



        .prevNext {
            max-width: 40px;
        }
    </style>

</head>

<body dir="rtl">

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a  href="#" class="navbar-brand page-scroll">
                    <img src="img/Tana1.png" alt="Logo" class="logo"><img src="img/Tana2.png" alt="Logo" class="logodark"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="Index.html">דף הבית <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Index.html#LoginSec">התחבר</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="Index.html#RegisterCustomer">הרשם</a>
                </li>               
                <li><a href="#Register" class="Index.html#page-scroll">הרשמה של בעל עסק</a></li> 
            </ul>
        </div>
    </nav>

    <header id="Carousel-intro" data-ride="carousel" class="intro carousel carousel-big slide carousel-fade">
        <ol class="carousel-indicators">
            <li data-target="#Carousel-intro" data-slide-to="0" class="active"></li>
            <li data-target="#Carousel-intro" data-slide-to="1"></li>
            <li data-target="#Carousel-intro" data-slide-to="2"></li>
        </ol>
        <div class="carousel-inner">
            <div class="item active">
                <div style="background-image:url(img/f.jpg)" class="fill">
                    <div class="intro-body">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-10 col-lg-offset-1">
                                    <h1>ברוכים הבאים למערכת ניהול תורים של</h1>
                                    <h1><span id="spnBizName"></span></h1>                                    
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="item">
                <div style="background-image:url(img/f.jpg)" class="fill">
                    <div class="intro-body">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-10 col-lg-offset-1">
                                    <h1>זמן תור</h1>
                                    <h1>מכל מקום</h1>
                                    <a class="btn btn-blue btn-lg page-scroll wow fadeInLeft" href="#Register">לחץ כאן להרשמה</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="item">
                <div style="background-image:url(img/f.jpg)" class="fill">
                    <div class="intro-body">
                        <div class="container">
                            <div class="row">
                                <div class="col-lg-10 col-lg-offset-1">
                                    <h1>מערכת לזימון תורים</h1>
                                    <h1>לכל עסק</h1>
                                    <a class="btn btn-blue btn-lg page-scroll wow fadeInLeft" href="#Register">לחץ כאן להרשמה</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <a href="#Carousel-intro" data-slide="prev" class="left carousel-control"><span class="icon-prev"></span></a><a href="#Carousel-intro" data-slide="next" class="right carousel-control"><span class="icon-next"></span></a>
    </header>

    <div class="d-flex justify-content-center">

        <div>

            <button type="button" style="float:right;margin-top:8px;" class="btn btn-primary btn-sm prevNext" id="prev">&lt;</button>

            <div style="float:right" class="p-2">

                <div class="input-group date">

                    <input type="text" id="datetimepicker1" class="form-control" placeholder="תאריך" style="max-width:140px;"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>

                </div>

            </div>

            <button type="button" id="next" class="btn btn-primary btn-sm prevNext" style="float:right;margin-top:8px;">&gt;</button>

        </div>

    </div>

    <div class="d-flex justify-content-center">

        <div class="btn-group-sm btn-group-primary" role="group" aria-label="...">
            <div class="floatR" onclick="SetCal('timeGrid')" style="width:40px;"><input class="rdb" id="btnDaily" type="radio" name="rdbX"><div class="check"></div><span class="floatR">יומי</span></div>
            <div class="floatR" onclick="SetCal('timeGridWeek')" style="width:50px;"><input class="rdb" id="btnWeekly" type="radio" name="rdbX"><div class="check"></div><span class="floatR">שבועי</span></div>
            <div class="floatR" onclick="SetCal('dayGridMonth')" style="width:50px;"><input class="rdb" id="btnMonthly" type="radio" name="rdbX"><div class="check"></div><span class="floatR">חודשי</span></div>
        </div>
    </div>
    <div id="dvddlActivity" style="float:right" class="p-2">
        <select class="form-control" style="width:130px;" id="ddlActivity"></select>
    </div>
    <div id="dvCustomers">
        <div class="d-flex justify-content-center">

            <div class="flex-row">

                <div id="dvddlCustomers" style="float:right" class="p-2">
                    <select class="form-control" style="width:170px;" id="ddlCustomers"></select>
                </div>

                <div style="float:right" class="p-2">
                    <button type="button" onclick="AddModalCustomer()" class="btn btn-primary btn-sm" style="margin-right:3px;">הוסף לקוח </button>
                </div>
            </div>
        </div>
    </div>
    <div id="dvUsers">
        <div class="d-flex justify-content-center">

            <div class="flex-row">

                <div id="dvddlCity" style="float:right" class="p-2">

                    <select style="width:100px;" id="ddlCity" placeholder="בחר עיר"></select>

                </div>

                <div id="dvddlUserers" style="float:right" class="p-2">

                    <select style="width:150px;" id="ddlUsers" placeholder="בחר בעל עסק"></select>

                </div>

                <!--<div style="float:right" class="p-2">

                    <button type="button" onclick="CheckAvailability()" class="btn btn-primary btn-sm" style="margin-right:3px;">בדוק </button>

                </div>-->

            </div>

        </div>
    </div>
    <div id="calendar"></div>



    <!--Add event modal-->

    <div id="createEventModal" class="modal fade">

        <div class="modal-dialog vertical-align-center">

            <div class="modal-content" style="width:320px;">

                <div class="modal-header">

                    <div style="float:right;color:#007bff;"><h4>זמן תור</h4></div>

                    <div style="float:left">

                        <button type="button" class="close" data-dismiss="modal">

                            <span aria-hidden="true">&times;</span> <span class="sr-only">close</span>

                        </button>

                    </div>

                </div>

                <div id="modalBody" class="modal-body">

                    <table style="border-collapse: separate;border-spacing: 10px;">

                        <tr>

                            <td style="float:right;">תור ל :</td>

                            <td colspan="3">

                                <select style="width:190px;" id="ddlEvent" class="form-control" type="text">

                                    <option value="0">בחר</option>

                                </select>

                                <div id="ddlEventErr"></div>

                            </td>

                        </tr>



                        <tr>

                            <td>מ :</td>

                            <td><input style="width:70px;" type="text" id="txtTimeFrom" class="form-control"></td>

                            <td>עד :</td>

                            <td><input style="width:70px;" type="text" id="txtTimeTo" class="form-control"></td>

                        </tr>

                    </table>

                </div>

                <div class="modal-footer">

                    <button class="btn" data-dismiss="modal" aria-hidden="true">ביטול</button>

                    <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="DeleteQue()" id="btnDeleteQue">מחק</button>

                    <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="AddQue()" id="submitButton">שמור</button>

                </div>

            </div>



        </div>

    </div>

    <div id="AddCustomerModal" class="modal fade">

        <div class="modal-dialog vertical-align-center">

            <div class="modal-content" style="width:320px;">

                <div class="modal-header">

                    <div style="float:right;color:#007bff;"><h4>הוסף לקוח</h4></div>

                    <div style="float:left">

                        <button type="button" class="close" data-dismiss="modal">

                            <span aria-hidden="true">&times;</span> <span class="sr-only">close</span>

                        </button>

                    </div>

                </div>

                <div id="modalBody" class="modal-body">

                    <div class="form-group">

                        <div class="form-group floating-label-form-group controls">

                            <input id="userCust" type="text" placeholder="שם משתמש" class="form-control input-lg" />

                        </div>

                    </div>

                    <div class="form-group">

                        <div class=& quot;form-group floating-label-form-group controls">

                            <input id="txtTelCust" type="text" placeholder="טלפון נייד" class="form-control input-lg" />

                        </div>

                    </div>

                </div>

                <div class="modal-footer">

                    <button class="btn" data-dismiss="modal" aria-hidden="true">ביטול</button>

                    <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="AddCustomer()" id="btnAddCustomer">הוספה</button>

                </div>

            </div>



        </div>

    </div>

    <div id="SysLoginModal" class="modal fade">

        <div class="modal-dialog vertical-align-center">

            <div class="modal-content" style="width:320px;">

                <div class="modal-header">

                    <div style="float:right;color:#007bff;"><h4>כניסה למערכת</h4></div>

                    <div style="float:left">

                        <button type="button" class="close" data-dismiss="modal">

                            <span aria-hidden="true">&times;</span> <span class="sr-only">close</span>

                        </button>

                    </div>

                </div>

                <div id="modalBody" class="modal-body">
                    <div class="container">

                        <div class="row">

                            <div class="">

                                <div style="text-align:right;font-weight:bold;">כניסה: </div>

                                <div class="form-group">

                                    <div class="form-group floating-label-form-group controls">

                                        <input id="emailLogin" type="email" placeholder="מייל" class="form-control input-lg" />

                                    </div>

                                </div>

                                <div class="form-group">

                                    <div class="form-group floating-label-form-group controls">

                                        <input id="passwordLogin" type="password" placeholder="סיסמה" class="form-control input-lg" />

                                    </div>

                                </div>

                                <div class="form-group" style="text-align:right">

                                    <label>זכור אותי</label>

                                    <label>

                                        <input type="checkbox">

                                    </label>

                                </div>                                

                            </div>

                        </div>
                    </div>
                </div>

                <div class="modal-footer">

                    <button class="btn" data-dismiss="modal" aria-hidden="true">ביטול</button>

                    <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="Login()" id="btnAddCustomer">כניסה</button>

                </div>

            </div>



        </div>

    </div>

</body>

</html>



<script type="text/javascript">

    var momentHourFormat = "HH:mm:ss";
    var todayX;
    var UserData = JSON.parse(sessionStorage.getItem("UserData"));
    
    var currentUserForCustomer;
    var currentUserDetails;

    var customersList;

    init();

    function init() {
      
       
            if (UserData.isUser) {

                $('#dvUsers').addClass('forceDispNone');

                getMyCustomers();

                setUser(UserData);

            }

            else {

                SetCustomer();

                $('#dvCustomers').addClass('forceDispNone');

            }
        
    }
    function AddModalCustomer() {

        $('#AddCustomerModal').modal('show');

    }


    function AddCustomer() {

        var Tel = $("#txtTelCust").val();

        var name = $("#userCust").val();



        if (name.length <= 0) {

            showTooltip("userCust", "נא להזין שם");

            return;

        }

        if (Tel.length <= 0) {

            showTooltip("txtTelCust", "נא להזין מספר טלפון נייד");

            return;

        }

        var CustomerObj = { Id: UserData.UserId, Name: name, tel: Tel, guid: UserData.guid };

        $.ajax({

            url: "User/UserAddCustmer",

            type: 'POST',

            data: JSON.stringify(CustomerObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data == "") {

                    $('#AddCustomerModal').modal('hide');

                    getMyCustomers();

                }

                else {

                    showTooltip("btnAddCustomer", data);

                }

            },

            error: function (request, status, error) {



            }

        });

    }

    function getMyCustomers() {

        var CustomerObj = { UserId: UserData.UserId, guid: UserData.guid };

        $.ajax({

            url: "User/GetCustomers",

            type: 'POST',

            data: JSON.stringify(CustomerObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data.message != "")

                    messageHandler.Show(data.message);

                else {



                    if (data.customersList != null && data.customersList.length > 0) {

                        customersList = data.customersList;

                        $('#ddlCustomers').selectize()[0].selectize.destroy();

                        selectizeService.InitSelectize("ddlCustomers", 'Id', 'Name', 30, data.customersList, null);

                    }

                    else

                        $('#AddCustomerModal').modal('show');

                }

            },

            error: function (request, status, error) {



            }

        });

    }

    function getNoActiveDays(BizTypeList) {
        //set unavailable days
        var notActiveDays = "";
        for (var i = 0; i < 7; i++) {

            var isDayFound = false;

            for (var j = 0; j < BizTypeList.length; j++) {

                if (BizTypeList[j].ActiveDay == (i + 1)) {
                    isDayFound = true;
                }
            }

            if (!isDayFound) {

                notActiveDays += i.toString() + ",";

            }
        }

        if (notActiveDays.length > 0)

            notActiveDays = notActiveDays.substr(0, notActiveDays.length - 1);

        return notActiveDays;
    }

    function setUser(userData) {
        var activeDays = [], notActiveDays = "";

        var index = 0;
        for (obj in userData.dicBizType) {
            $('#ddlActivity').append($("<option></option>").attr("value", userData.dicBizType[obj][0].EmployeeId).text(obj));
        }

        $('#ddlActivity').on('change', function () {            
            var empId = $('#ddlActivity :selected').text();
            var BizTypeList = userData.dicBizType[empId];
            setUserActivities(BizTypeList);
        });

        for (var i = 0; i < userData.Activities.length; i++) {
            $('#ddlEvent').append($("<option></option>").attr("value", userData.Activities[i].Id).text(userData.Activities[i].Name));
        }

        var currentEmployee = $('#ddlActivity :selected').text();
        var BizTypeList = userData.dicBizType[currentEmployee];

        setUserActivities(BizTypeList);

    }

    function setUserActivities(BizTypeList) {
        CheckTodayAvailable(BizTypeList, UserData.day);

        notActiveDays = getNoActiveDays(BizTypeList);

        setDatePicker(notActiveDays);

        GetQue(UserData, currentUserDetails);
    }

    function CheckTodayAvailable(BizTypeList, day) {
        //check is Today Available

        var isTodayAvailable = false;

        for (var i = 0; i < BizTypeList.length; i++) {

            if (day == BizTypeList[i].ActiveDay) {

                isTodayAvailable = true;

                currentUserDetails = BizTypeList[i];

                break;

            }

        }

        return isTodayAvailable;
    }

    function setDatePicker(DaysOfWeekDisabled) {

        $('#datetimepicker1').datepicker({

            format: "dd/mm/yyyy",

            language: "he",

            daysOfWeekDisabled: DaysOfWeekDisabled,

            orientation: "auto",

            todayHighlight: true

        });

        $('#datetimepicker1').val(moment(new Date()).format('DD/MM/YYYY'));
        todayX = moment(new Date()).format('YYYY-MM-DD');
    }

    function SetCal(view) {
        SetCalRadioButton(view);
        GetQue(UserData, currentUserDetails, view);
    }
    function SetCalRadioButton(view) {
        switch (view) {
            case 'timeGrid': {
                $("#btnDaily").prop('checked', true);
                break;
            }
            case 'timeGridWeek': {
                $("#btnWeekly").prop('checked', true);
                break;
            }
            case 'dayGridMonth': {
                $("#btnMonthly").prop('checked', true);
                break;
            }
        }
    }
    function GetQue(UserData, currentUserDetails, view) {
        var fromDate, toDate;

        //var today = moment().format('YYYY-MM-DD');

        fromDate = todayX + "T00:00:00";

        toDate = todayX + "T23:59:59";

        var duration = 10;
               
        if (view == null) {
            if (sessionStorage.getItem("LastView") != null) {
                view = sessionStorage.getItem("LastView");
            }
            else {
                view = 'timeGrid';                
            }            
        }
        else if (view == 'timeGridWeek') {

            var today = moment();

            fromDate = today.startOf('week').format('YYYY-MM-DD') + "T00:00:00";

            toDate = today.endOf('week').format('YYYY-MM-DD') + "T23:59:59";            
        }
        else {
            var today = moment();

            fromDate = today.startOf('month').format('YYYY-MM-DD') + "T00:00:00";

            toDate = today.endOf('month').format('YYYY-MM-DD') + "T23:59:59";
        }

        SetCalRadioButton(view);

        var QueObj = {
            UserId: UserData.isUser ? UserData.UserId : $('#ddlUsers').val(),
            guid: UserData.guid,
            FromDate: fromDate,
            ToDate: toDate,
            isUser: UserData.isUser,
            CustomerId: UserData.CustomerId,
            EmployeeId: currentUserDetails.EmployeeId
        };


        $.ajax({

            url: "Que/GetQue",

            type: 'POST',

            data: JSON.stringify(QueObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data.Message != null && data.Message != "") {

                    messageHandler.Show(data.Message);

                }

                else {

                    $("#calendar").html("");

                    //CreateCal(data.queData, '09:00:00', '18:00:00', duration, view);

                    var ActiveHourFrom = currentUserDetails != null && currentUserDetails.ActiveHourFrom != null ? currentUserDetails.ActiveHourFrom : '09:00:00';

                    var ActiveHourTo = currentUserDetails != null && currentUserDetails.ActiveHourTo != null ? currentUserDetails.ActiveHourTo : '19:00:00';

                    var d = todayX + "T";
                    CreateCal(data.queData,  ActiveHourFrom, ActiveHourTo, duration, view);//timeGrid dayGridMonth,timeGridWeek'

                }

            },

            error: function (request, status, error) {



            }

        });

    }

    function calcHourLength(minimumTime, maximumTime, duration) {



        var startTime = moment(minimumTime, momentHourFormat);

        var endTime = moment(maximumTime, momentHourFormat);

        var durationX = moment.duration(endTime.diff(startTime));

        var hours = parseInt(durationX.asHours());

        var minutes = parseInt(durationX.asMinutes()) % 60;

        var total = ((hours * 60) + minutes) / duration;

        return total

    }

    function getEmptyEvent(index, start, end) {
        return { id: index, title: "פנוי", start:  start, end:  end, editable: true, color: '#fff' };
    }

    function createEmptyDaySchedule(data, minimumTime, maximumTime, duration) {

        var dataNew = [];

        var len = calcHourLength(minimumTime, maximumTime, duration);

        var startTime = moment(minimumTime, momentHourFormat);

        var endTime = moment(minimumTime, momentHourFormat).add(duration, "minutes");

        var j = 0;

        for (var i = 0; i < len; i++) {



            var t1 = data != null && data[j] != null ? moment(data[j].start).format(momentHourFormat) : 0;

            if (t1 == startTime.format(momentHourFormat)) {

                var d = getEmptyEvent(i, data[j].start, data[j].end);

                d.id = data[j].Id;

                d.title = data[j].title;

                d.start = data[j].start;

                d.end = data[j].end;

                d.color = "#007bff";

                d.textColor = "#fff";

                dataNew.push(d);

                j++;

            }

            else

                dataNew.push(getEmptyEvent(i, todayX + "T" + startTime.format(momentHourFormat), todayX + "T" + endTime.format(momentHourFormat)));



            startTime = endTime;

            endTime = moment(endTime, momentHourFormat).add(duration, "minutes");

        }

        return dataNew;

    }

    var currentId = -1;
    var currentDate = "";
    var currentCustomerName = "";
    var LastView = "";
    var calendar;


    function CreateCal(data, minimumTime, maximumTime, duration, view) {

        var len = calcHourLength(minimumTime, maximumTime, duration);
        LastView = view;
        
        var dataEvents;

        dataEvents = data;//createEmptyDaySchedule(data, minimumTime, maximumTime, duration);

        var calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {

            //plugins: ['bootstrap', 'dayGrid', 'timeGrid'],
            plugins: ['interaction', 'dayGrid', 'timeGrid'],

            //eventColor: '#378006',

            header: { // layout header
                left: '',
                center: '',
                right: 'month,agendaWeek,listWeek'
            },
            buttonText: {
                today: 'היום',
                left: 'הבא'
            },            
            displayEventTime: false,
            timeZone: 'UTC',
            defaultView: view,//'timeGrid',
            minTime: minimumTime,
            maxTime: maximumTime,
            slotDuration: '00:' + duration + ':00',
            slotLabelFormat: {
                hour: 'numeric',
                minute: '2-digit',
                omitZeroMinute: false,
                meridiem: 'short'
            },
            textColor: '#FFF',
            slotLabelInterval: parseInt(duration),
            editable: true,
            eventLimit: true,
            selectable: true,
            //dateClick: function(info) {
            //    alert('clicked ' + info.dateStr);
            //},
            select: function(info) {
                SetCalData(info);
            },
            eventClick: function (info) {

                SetCalData(info);

            },

            locale: 'he',

            dir: 'rtl',            

            titleFormat: { year: 'numeric', month: 'numeric', day: 'numeric' },

            themeSystem: 'bootstrap',

            allDaySlot: false,

            events: dataEvents

        });

        calendar.render();

        return calendar;

    }

    function SetCalData(info) {
        var SelectedCustomer = $('#ddlCustomers').val();
        
        if (info.event == null && UserData.isUser && SelectedCustomer == "") {
            showTooltip("dvddlCustomers", "נא לבחור לקוח")
            return;

        }
        
        if (info.event != null && info.event.title == 'תפוס')
            return;

        currentId = info.event? info.event.id : 0;
        var InfoObj = info.event ? info.event : info;
        currentDate = moment(InfoObj.start).format('YYYY-MM-DD') + "T";
        
        //if (currentUserForCustomer != null && currentUserForCustomer.dicBizType != null) {
        //    var BizTypeList = currentUserForCustomer.dicBizType[$('#ddlActivity :selected').text()];
        //    var check = moment(InfoObj.start, 'YYYY/MM/DD');
        //    var isInDay = false;
        //    var day   = check.format('D');
        //    for (var i = 0; i < BizTypeList.length; i++) {
        //        if (BizTypeList[i].ActiveDay == day) {
        //            isInDay = true;
        //            break;
        //        }
        //    }
        //    if (!isInDay)
        //        return;
        //}

        var s = moment(InfoObj.start).add(-3, 'hours');
        var timeDiff = moment().diff(s, 'second');
        if (timeDiff > 200) {            
            return;
        }
        var e = moment(InfoObj.end).add(-3, 'hours');

        $('#txtTimeFrom').val(s.format("HH:mm"));

        $('#txtTimeTo').val(e.format("HH:mm"));

        $('#ddlEvent').val("0");


        if (info.event==null)

            btnDeleteQue.style.display = "none";

        else {

            var titleArr = InfoObj.title.split(' ');

            if (titleArr.length > 1) {

                var qType = titleArr[0];

                var qCustomer = "";

                for (var j = 1; j < titleArr.length; j++)

                    qCustomer += titleArr[j] + ' ';

                qCustomer = qCustomer.trim();

                var qTypeId = findEventByName(qType);
                if(qTypeId!=null)
                    $('#ddlEvent').val(qTypeId.Id);

                currentCustomerName = qCustomer;

            }

            btnDeleteQue.style.display = "";

        }

        $('#createEventModal').modal('show');

        //}
    }

    $("#next").click(function () {

        calendar.next();

    });



    $("#prev").click(function () {

        calendar.prev();

    });



    $("#today").click(function () {

        calendar.today();

    });



    function AddQue() {

        var eventId = $('#ddlEvent').val();

        var employeeId = $('#ddlActivity').val();

        var txtFrom = $("#txtTimeFrom").val();

        var txtTo = $("#txtTimeTo").val();

        if (eventId == null || eventId == 0) {

            showTooltip('ddlEventErr', "נא לבחור תור");

            return;
        }

        if (txtFrom.length <= 0) {

            showTooltip('txtTimeFrom', "נא להזין שעה");

            return;

        }

        if (!isHour(txtFrom)) {

            showTooltip('txtTimeFrom', "נא להזין שעה תקינה");

            return;

        }

        if (txtTo.length <= 0) {

            showTooltip('txtTimeTo', "נא להזין שעה");

            return;

        }

        if (!isHour(txtTo)) {

            showTooltip('txtTimeTo', "נא להזין שעה תקינה");

            return;

        }

        var QueObj = {

            UserId: UserData.UserId,

            guid: UserData.guid,

            FromDate: currentDate+txtFrom,

            ToDate: currentDate+txtTo,

            isUser: UserData.isUser,

            CustomerId: $('#ddlCustomers').val(),            

            QueType: eventId,
            EmployeeId: employeeId

        };



        $.ajax({

            url: "Que/AddCustomerQue",

            type: 'POST',

            data: JSON.stringify(QueObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data == "") {
                    sessionStorage.setItem("LastView", LastView);
                    GetQue(UserData, currentUserDetails);

                    $('#createEventModal').modal('hide');

                }

                else

                    showTooltip('ddlEventErr', data);

            },

            error: function (request, status, error) {

            }

        });
    }

    function findCustomerId() {

        for (var i = 0; i < customersList.length; i++) {
            
            if (customersList[i].Name === currentCustomerName) {

                return customersList[i].Id;

            }

        }

        return -1;

    }

    function findEventByName(name) {
        for (var i = 0; i < UserData.Activities.length; i++) {
            if (UserData.Activities[i].Name == name)
                return UserData.Activities[i];            
        }
        return null;
    }
 

    function DeleteQue() {

        var obj = calendar.getEventById(currentId);

        var eventName = UserData.isUser ? $('#ddlEvent').val() : obj.title;

        var txtFrom = $("#txtTimeFrom").val();

        var txtTo = $("#txtTimeTo").val();

        var custId = UserData.isUser ? findCustomerId() : UserData.CustomerId;

        var empId = UserData.isUser ? $('#ddlActivity').val() : 0;

        if (custId < 0) {

            return;

        }

        var QueObj = {

            UserId: UserData.UserId,

            guid: UserData.guid,

            FromDate: todayX + "T" + txtFrom,

            ToDate: todayX + "T" + txtTo,

            isUser: UserData.isUser,

            CustomerId: custId,

            QueTime: 10,

            QueType: eventName,

            EmployeeId:empId

        };



        $.ajax({

            url: "Que/DeleteCustomerQue",

            type: 'POST',

            data: JSON.stringify(QueObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data == "") {

                    GetQue(UserData, currentUserDetails);

                    $('#createEventModal').modal('hide');

                }

                else

                    showTooltip('ddlEventErr', data);

            },

            error: function (request, status, error) {



            }

        });

    }

    function addEventToCal(eventName, txtFrom, txtTo) {

        var item = { title: eventName, start: todayX + "T" + txtFrom.value + "", end: todayX + "T" + txtTo.value + "" };

        //data.push(item);

        var ev = calendar.getEventById(currentId);

        ev.remove(currentId);



        calendar.addEvent({

            id: currentId,

            title: eventName,

            start: todayX + "T" + txtFrom.value + "",

            end: todayX + "T" + txtTo.value + "",

            editable: true,

            color: '#fff'

        });

        $('#createEventModal').modal('hide');

    }

    function SetCustomer() {

        getCities(function (data) {
            selectizeService.InitSelectize("ddlCity", 'Id', 'Name', null, data, null);
        });


        $('#ddlUsers').selectize({

            valueField: 'Id',

            labelField: 'User',

            searchField: 'User',

            options: [],

            create: false,

            render: {

                option: function (item, escape) {

                    return '<div>' + escape(item.User) + '</div>';
                }
            },
            onChange: function (value) {
                // get user default activities
                var UserSearch = { Id: value, guid: UserData.guid }

                $.ajax({

                    url: "User/GetUserById",

                    type: 'POST',

                    data: JSON.stringify(UserSearch),

                    contentType: "application/json;charset=utf-8",

                    success: function (data) {

                        if (data != null && data.dicBizType != null) {
                            currentUserForCustomer = data;
                            setUser(data);
                            //CheckTodayAvailable(data.dicBizType, data.day);

                        }

                        else {

                            if (data.ErrorMsg != "")

                                showTooltip('ddlUsers', data.ErrorMsg);

                            else

                                showTooltip('ddlUsers', "ארעה שגיאה");

                        }

                    },

                    error: function (request, status, error) {



                    }

                });

            },

            load: function (query, callback) {

                var city = $('#ddlCity').val();

                if (city == "") {

                    showTooltip("dvddlCity", "נא להזין עיר")

                    return;

                }

                if (query.length < 3) return;

                var data = {

                    User: query,

                    tel: "",

                    Adrress: "",

                    City: city,

                    guid: UserData.guid
                }



                $.ajax({

                    url: 'User/GetUsers',

                    type: 'POST',

                    contentType: "application/json;charset=utf-8",

                    data: JSON.stringify(data),



                    error: function () {

                        callback();

                    },

                    success: function (result) {

                        callback(result.usersList);

                    }

                });

            }

        });

    }



    function CheckAvailability() {

        var user = $('#ddlUsers').val();

        if (user == "") {

            showTooltip('dvddlUserers', 'נא להזין שם עסק')

            return;

        }

        UserData.UserId = user;

        GetQue(UserData, null);

    }

</script>