<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title></title>
    <link href="css/cal.css" rel="stylesheet" />
    <link href="css/main.css" rel="stylesheet" />

    <link href="css/selectize.css" rel="stylesheet" />
    <link href='https://use.fontawesome.com/releases/v5.0.6/css/all.css' rel='stylesheet'>
    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/css/bootstrap-datepicker.css" rel='stylesheet' />
    <link href="css/general.css" rel="stylesheet" />
    <script src="js/cal.js"></script>
    <script src="js/moment.js"></script>

    <script src="js/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.8.0/locales/bootstrap-datepicker.he.min.js"></script>
    <script src="js/selectize.js"></script>


    <style>
        .fc-widget-header {
            color: #007bff;
        }

        .selectize-input {
            direction: rtl !important;
            text-align: right !important;
        }

        .selectize-dropdown {
            direction: rtl !important;
            text-align: right !important;
        }

        .tooltip-inner {
            background-color: #f00 !important;
        }



        @media only screen and (max-width: 760px) {

            .fc-content {
                padding: 5px;
                font-size: 10px;
            }



            .fc-time-grid .fc-slats td {
                height: 3.5em;
            }
        }



        .prevNext {
            max-width: 40px;
        }
    </style>

</head>

<body dir="rtl">

    <nav role="navigation">
        <div class="menuContainer" onclick="showMenu(this)">
            <div class="bar1"></div>
            <div class="bar2"></div>
            <div class="bar3"></div>
        </div>
        <div style="text-align:right; width:100%; position:absolute;background-color:#fff;z-index:1000" id="menuToggle">
            <ul style="display:none;list-style-type: none" id="menuItems">
                <li class="nav-item active">
                    <a class="nav-link" href="javascript:navigateTo('start.html')">דף הבית <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:navigateTo('start.html#LoginSec')">התחבר</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="javascript:navigateTo('start.html#RegisterCustomer')">הרשם</a>
                </li>
                <li id="liUpdateBiz" style="display:none"><a href="javascript:navigateTo('BizUpdate.html')" class="nav-link">עדכון פרטי עסק</a></li>
            </ul>
        </div>
        <div style="float:right;padding-right: 10px;">

            <button type="button" style="float:right;margin-top:8px;height:30px;" class="btn btn-primary btn-sm prevNext" id="prev">&lt;</button>

            <div style="float:right" class="p-2">

                <div class="input-group date">

                    <input type="text" id="datetimepicker1" onchange="CheckDatePicker(this)" class="form-control" placeholder="תאריך" style="height:30px;max-width:110px;"><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>

                </div>

            </div>

            <button type="button" id="next" class="btn btn-primary btn-sm prevNext" style="float:right;margin-top:8px;height:30px;">&gt;</button>

        </div>

    </nav>



    <div class="d-flex justify-content-center">

        <div class="btn-group-sm btn-group-primary" role="group" aria-label="...">
            <div class="floatR" onclick="SetCal('timeGrid')" style="width:40px;"><input class="rdb" id="btnDaily" type="radio" name="rdbX"><div class="check"></div><span class="floatR">יומי</span></div>
            <div class="floatR" onclick="SetCal('timeGridWeek')" style="width:50px;"><input class="rdb" id="btnWeekly" type="radio" name="rdbX"><div class="check"></div><span class="floatR">שבועי</span></div>
            <div class="floatR" onclick="SetCal('dayGridMonth')" style="width:50px;"><input class="rdb" id="btnMonthly" type="radio" name="rdbX"><div class="check"></div><span class="floatR">חודשי</span></div>
        </div>
    </div>
    <div style="float:right;text-align:left" class="p-2">
        <select placeholder="בחר עובד" class="form-control" style="width:100px;" id="ddlActivity"></select>
    </div>
    <div style="float:right;text-align:left" class="p-2">
        <select style="width:110px;" id="ddlEvent" class="form-control" type="text"></select>
    </div>
        <div id="dvCustomers">
            <div class="d-flex justify-content-center">

                <div class="flex-row">

                    <div id="dvddlCustomers" style="float:right" class="p-2">
                        <select placeholder="בחר לקוח" style="width:110px;" id="ddlCustomers"></select>
                    </div>

                    <div style="float:right" class="p-2">
                        <button type="button" onclick="AddModalCustomer()" class="btn btn-primary btn-sm" style="margin-right:10px;height:35px;">הוסף לקוח </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="dvUsers">
            <div class="d-flex justify-content-center">

                <div class="flex-row">

                    <div id="dvddlCity" style="float:right" class="p-2">
                        <select style="width:100px;" id="ddlCity" placeholder="בחר עיר"></select>
                    </div>
                    <div id="dvddlUserers" style="float:right" class="p-2">
                        <select style="width:110px;" id="ddlUsers" placeholder="בחר בעל עסק"></select>
                    </div>
                </div>
            </div>
        </div>
        <div id="calendar"></div>

        <!--Add event modal-->

        <div id="createEventModal" class="modal fade">

            <div class="modal-dialog vertical-align-center">

                <div class="modal-content" style="width:320px;">

                    <div class="modal-header">

                        <div style="float:right;color:#007bff;"><h4>זמן תור<span id="spnEventMsg"></span></h4></div>
                        <div style="float:left">

                            <button type="button" class="close" data-dismiss="modal">

                                <span aria-hidden="true">&times;</span> <span class="sr-only">close</span>

                            </button>

                        </div>

                    </div>

                    <div id="modalBody" class="modal-body">

                        <table style="border-collapse: separate;border-spacing: 10px;">

                            <tr>

                                <td style="float:right;">תור ל :</td>

                                <td colspan="3">

                                    <div style="text-align:right" id="dvEventName"></div>

                                    <div id="ddlEventErr"></div>

                                </td>

                            </tr>



                            <tr>

                                <td>מ :</td>

                                <td><input style="width:70px;" type="text" id="txtTimeFrom" class="form-control"></td>

                                <td>עד :</td>

                                <td><input style="width:70px;" type="text" id="txtTimeTo" class="form-control"></td>

                            </tr>

                        </table>

                    </div>

                    <div class="modal-footer">

                        <button class="btn" data-dismiss="modal" aria-hidden="true">ביטול</button>

                        <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="DeleteQue()" id="btnDeleteQue">מחק</button>

                        <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="AddQue()" id="submitButton">שמור</button>

                    </div>

                </div>



            </div>

        </div>

        <div id="AddCustomerModal" class="modal fade">

            <div class="modal-dialog vertical-align-center">

                <div class="modal-content" style="width:320px;">

                    <div class="modal-header">

                        <div style="float:right;color:#007bff;"><h4>הוסף לקוח</h4></div>

                        <div style="float:left">

                            <button type="button" class="close" data-dismiss="modal">

                                <span aria-hidden="true">&times;</span> <span class="sr-only">close</span>

                            </button>

                        </div>

                    </div>

                    <div id="modalBody" class="modal-body">

                        <div class="form-group">

                            <div class="form-group floating-label-form-group controls">

                                <input id="userCust" type="text" placeholder="שם משתמש" class="form-control input-lg" />

                            </div>

                        </div>

                        <div class="form-group">

                            <div class=& quot;form-group floating-label-form-group controls">

                                <input id="txtTelCust" type="text" placeholder="טלפון נייד" class="form-control input-lg" />

                            </div>

                        </div>

                    </div>

                    <div class="modal-footer">

                        <button class="btn" data-dismiss="modal" aria-hidden="true">ביטול</button>

                        <button type="submit" style="margin-right:5px;" class="btn btn-primary" onclick="AddCustomer()" id="btnAddCustomer">הוספה</button>

                    </div>

                </div>



            </div>

        </div>

</body>

</html>



<script type="text/javascript">

    var momentHourFormat = "HH:mm:ss";
    var todayX;
    var UserData = JSON.parse(sessionStorage.getItem("UserData"));
    var notActiveDays = "";
    var currentUserForCustomer;
    var currentUserDetails;
    var UserForCustomerDetails;
    var customersList;
    var isPageLoad = true;
    var currentId = -1;
    var currentDate = "";
    var currentCustomerName = "";
    var LastView = "";
    var calendar;

    getScripts();

    function showMenu(x) {
        x.classList.toggle("change");
        $("#menuItems").toggle();
    }

    function getScripts() {
        var v = sessionStorage.getItem("version");
        $.ajax({
            url: "js/global.js?ver=" + v,
            dataType: "script",
            success: function (data) {

                init();
            },
            error: function (request, status, error) {

            }
        });


    }

    function init() {

        if (UserData == null) {
            location.href = "main.html";
        }
        if (UserData.isUser) {

            $('#dvUsers').addClass('forceDispNone');

            getMyCustomers();

            setUser(UserData);
            $('#liUpdateBiz').show();
        }

        else {

            SetCustomer();

            $('#dvCustomers').addClass('forceDispNone');

            UserForCustomerDetails = JSON.parse(sessionStorage.getItem("UserForCustomerDetails"));
            if (UserForCustomerDetails == null) {
                setTimeout(showTooltip("ddlCity", "נא לבחור עיר"), 1000);
            }
            else {
                setTimeout(function () {
                    selectizeService.setValue('ddlCity', UserForCustomerDetails.City);

                    var selectizeMe = $("#ddlUsers")
                    var v = selectizeMe[0].selectize;
                    v.addOption({ Id: UserForCustomerDetails.Id, User: UserForCustomerDetails.User }); //option can be created manually or loaded using Ajax
                    v.addItem(UserForCustomerDetails.Id);
                }, 100);
            }
        }

    }

    function AddModalCustomer() {

        $('#AddCustomerModal').modal('show');

    }

    function AddCustomer() {

        var Tel = $("#txtTelCust").val();

        var name = $("#userCust").val();



        if (name.length <= 0) {

            showTooltip("userCust", "נא להזין שם");

            return;

        }

        if (Tel.length <= 0) {

            showTooltip("txtTelCust", "נא להזין מספר טלפון נייד");

            return;

        }

        var CustomerObj = { Id: UserData.UserId, Name: name, tel: Tel, guid: UserData.guid };

        $.ajax({

            url: "User/UserAddCustmer",

            type: 'POST',

            data: JSON.stringify(CustomerObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data == "") {

                    $('#AddCustomerModal').modal('hide');

                    getMyCustomers();

                }

                else {

                    showTooltip("btnAddCustomer", data);

                }

            },

            error: function (request, status, error) {



            }

        });

    }

    function getMyCustomers() {

        var CustomerObj = { UserId: UserData.UserId, guid: UserData.guid };

        $.ajax({

            url: "User/GetCustomers",

            type: 'POST',

            data: JSON.stringify(CustomerObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data.message != "")

                    messageHandler.Show(data.message);

                else {



                    if (data.customersList != null && data.customersList.length > 0) {

                        customersList = data.customersList;

                        $('#ddlCustomers').selectize()[0].selectize.destroy();

                        selectizeService.InitSelectize("ddlCustomers", 'Id', 'Name', 38, data.customersList, null);

                    }

                    else

                        $('#AddCustomerModal').modal('show');

                }

            },

            error: function (request, status, error) {



            }

        });

    }

    function getNoActiveDays(BizTypeList) {
        //set unavailable days
        if (BizTypeList != null) {
            for (var i = 0; i < 7; i++) {

                var isDayFound = false;

                for (var j = 0; j < BizTypeList.length; j++) {

                    if (BizTypeList[j].ActiveDay == (i + 1)) {
                        isDayFound = true;
                    }
                }

                if (!isDayFound) {

                    notActiveDays += i.toString() + ",";

                }
            }
        }
        if (notActiveDays.length > 0)

            notActiveDays = notActiveDays.substr(0, notActiveDays.length - 1);

        return notActiveDays;
    }

    function setUser(userData) {
        var activeDays = [], notActiveDays = "";
        document.getElementById("ddlActivity").options.length = 0;
        var index = 0;
        for (obj in userData.dicBizType) {
            $('#ddlActivity').append($("<option></option>").attr("value", userData.dicBizType[obj][0].EmployeeId).text(obj));
        }

        $('#ddlActivity').on('change', function () {
            var empId = $('#ddlActivity :selected').text();
            var BizTypeList = userData.dicBizType[empId];
            setUserActivities(BizTypeList);

            var id = parseInt($('#ddlActivity').val());
            var empActList = UserData.dicEmployeeActivities[id];
            setEmployeeActivities(empActList);
        });


        try {
            var empActList = UserData.dicEmployeeActivities[1];//get default emp
            setEmployeeActivities(empActList);
        }
        catch (e) { }

        var currentEmployee = $('#ddlActivity :selected').text();
        var BizTypeList = userData.dicBizType[currentEmployee];

        setUserActivities(BizTypeList);

    }

    function setEmployeeActivities(empActList) {

        document.getElementById("ddlEvent").options.length = 0;//reset activities
        for (var i = 0; i < UserData.Activities.length; i++) {
            if (include(empActList, UserData.Activities[i].Id))
                $('#ddlEvent').append($("<option></option>").attr("value", UserData.Activities[i].Id).text(UserData.Activities[i].Name));
        }
    }

    function include(arr, obj) {
        for (var i = 0; i < arr.length; i++) {
            if (arr[i] == obj) return true;
        }
    }
    function setUserActivities(BizTypeList) {
        CheckTodayAvailable(BizTypeList, UserData.day);

        notActiveDays = getNoActiveDays(BizTypeList);

        setDatePicker(notActiveDays);
        if (LastView == "")
            LastView = "timeGridWeek";
        GetQue(UserData, currentUserDetails, LastView);
    }

    function CheckTodayAvailable(BizTypeList, day) {
        //check is Today Available

        var isTodayAvailable = false;
        if (BizTypeList != null) {
            for (var i = 0; i < BizTypeList.length; i++) {

                if (day == BizTypeList[i].ActiveDay) {

                    isTodayAvailable = true;

                    currentUserDetails = BizTypeList[i];

                    break;

                }

            }
        }
        return isTodayAvailable;
    }
    function CheckDatePicker(obj) {

        todayX = moment(obj.value, 'DD/MM/YYYY').format('YYYY-MM-DD');
        GetQue(UserData, currentUserDetails, GetCalRadioButton());
        calendar.gotoDate(todayX);

        $('#datetimepicker1').datepicker('hide');

    }
    function setDatePicker(DaysOfWeekDisabled) {

        $('#datetimepicker1').datepicker({

            format: "dd/mm/yyyy",

            language: "he",

            daysOfWeekDisabled: DaysOfWeekDisabled,

            orientation: "auto",

            todayHighlight: true

        });

        $('#datetimepicker1').val(moment(new Date()).format('DD/MM/YYYY'));
        todayX = moment(new Date()).format('YYYY-MM-DD');
    }

    function SetCal(view) {
        //todayX = moment($('#datetimepicker1').val(), 'DD/MM/YYYY').format('YYYY-MM-DD');
        SetCalRadioButton(view);
        GetQue(UserData, currentUserDetails, view);
        calendar.gotoDate(todayX);
    }
    function SetCalRadioButton(view) {
        switch (view) {
            case 'timeGrid': {
                $("#btnDaily").prop('checked', true);
                break;
            }
            case 'timeGridWeek': {
                $("#btnWeekly").prop('checked', true);
                break;
            }
            case 'dayGridMonth': {
                $("#btnMonthly").prop('checked', true);
                break;
            }
        }
    }

    function GetCalRadioButton() {
        if ($("#btnDaily").is(":checked"))
            return 'timeGrid';
        else if ($("#btnWeekly").is(":checked"))
            return 'timeGridWeek';
        else if ($("#btnMonthly").is(":checked"))
            return 'dayGridMonth';
        else
            return 'timeGrid';
    }

    function getActiveDuration() {
        var selectedEvent = $('#ddlEvent').val();
        for (var i = 0; i < UserData.Activities.length; i++) {
            if (selectedEvent == UserData.Activities[i].Id) {
                return UserData.Activities[i].ActiveDuration;
            }
        }
        return 10;
    }


    function GetQue(UserData, currentUserDetails, view) {
        var fromDate, toDate;

        var duration = 10;
                

        if (view == null || view == 'timeGrid') {
            view = 'timeGrid';
            fromDate = todayX + "T00:00:00";

            toDate = todayX + "T23:59:59";
        }
        else if (view == 'timeGridWeek') {

            var today = moment(todayX);

            fromDate = today.startOf('week').format('YYYY-MM-DD') + "T00:00:00";

            toDate = today.endOf('week').format('YYYY-MM-DD') + "T23:59:59";
        }
        else {
            var today = moment(todayX);

            fromDate = today.startOf('month').format('YYYY-MM-DD') + "T00:00:00";

            toDate = today.endOf('month').format('YYYY-MM-DD') + "T23:59:59";
        }

        SetCalRadioButton(view);

        var QueObj = {
            UserId: UserData.isUser ? UserData.UserId : $('#ddlUsers').val(),
            guid: UserData.guid,
            FromDate: fromDate,
            ToDate: toDate,
            isUser: UserData.isUser,
            CustomerId: UserData.CustomerId,
            EmployeeId: currentUserDetails?currentUserDetails.EmployeeId:0
        };
        var ActiveHourFrom = currentUserDetails != null && currentUserDetails.ActiveHourFrom != null ? currentUserDetails.ActiveHourFrom : '09:00:00';

        var ActiveHourTo = currentUserDetails != null && currentUserDetails.ActiveHourTo != null ? currentUserDetails.ActiveHourTo : '19:00:00';
        $("#calendar").html("");
        CreateCal(QueObj, ActiveHourFrom, ActiveHourTo, duration, view);

    }


    function CreateCal(data, minimumTime, maximumTime, duration, view) {

        LastView = view;

        var dataEvents;

        dataEvents = data;

        var calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {

            //plugins: ['bootstrap', 'dayGrid', 'timeGrid'],
            plugins: ['interaction', 'dayGrid', 'timeGrid'],

            //eventColor: '#378006',
            height: 650,
            header: { // layout header
                left: '',
                center: '',
                right: 'month,agendaWeek,listWeek'
            },
            buttonText: {
                today: 'היום',
                left: 'הבא'
            },
            displayEventTime: false,
            defaultView: view,//'timeGrid',
            minTime: minimumTime,
            maxTime: maximumTime,
            slotDuration: '00:' + duration + ':00',
            slotLabelFormat: {
                hour: 'numeric',
                minute: '2-digit',
                omitZeroMinute: false,
                meridiem: 'short'
            },
            textColor: '#FFF',
            slotLabelInterval: parseInt(duration),
            editable: true,
            eventLimit: true,
            selectable: true,
            longPressDelay: 130,
            //dateClick: function(info) {
            //    alert('clicked ' + info.dateStr);
            //},
            select: function (info) {
                SetCalData(info);
            },
            eventClick: function (info) {
                SetCalData(info);
            },
            locale: 'he',
            dir: 'rtl',
            titleFormat: { year: 'numeric', month: 'numeric', day: 'numeric' },
            //hiddenDays: hiddenDaysArr,
            themeSystem: 'bootstrap',

            allDaySlot: false,
            eventSources: [{
                url: 'Que/GetQue',
                method: 'POST',
                extraParams: data,
                failure: function () {

                }
            }]

        });



        calendar.render();

        //return calendar;

    }


    function deleteDayNoneWork(d) {

        if (d) {
            var date = moment(d).format('YYYY-MM-DD') + "T";
            var obj = {
                UserId: UserData.UserId,
                EmployeeId: $('#ddlActivity').val(),
                From: date + "00:00:00",
                To: date + "23:59:59",
                guid: UserData.guid

            };
            $.ajax({

                url: "User/AddUserExtraActivity",

                type: 'POST',

                data: JSON.stringify(obj),

                contentType: "application/json;charset=utf-8",

                success: function (data) {
                    $('#dvConfirmModal').modal('hide');
                    if (data != "") {
                        messageHandler.Show(data);
                    }
                    else {
                        GetQue(UserData, currentUserDetails, LastView);
                        calendar.gotoDate(todayX);
                    }

                },

                error: function (request, status, error) {
                    $('#dvConfirmModal').modal('hide');
                }

            });
        }
    }
    function CanceldeleteDay() {
        $('#dvConfirmModal').modal('hide');
    }


    function SetCalData(info) {

        var SelectedCustomer = $('#ddlCustomers').val();

        if (info.event == null && UserData.isUser && SelectedCustomer == "") {
            showTooltip("dvddlCustomers", "נא לבחור לקוח")
            return;

        }

        if (info.event != null && info.event.backgroundColor == '#f00') {
            if (UserData.isUser) {
                messageHandler.Confirm("האם ברצונך לעבוד ביום זה?",
                    function () { deleteDayNoneWork(info.event.start); return; }, function () { CanceldeleteDay(); return; });

            }

            return;
        }

        currentId = info.event ? info.event.id : 0;
        var InfoObj = info.event ? info.event : info;
        currentDate = moment(InfoObj.start).format('YYYY-MM-DD') + "T";

        var s = moment(InfoObj.start);//.add(-3, 'hours');
        var timeDiff = moment().diff(s, 'second');
        if (timeDiff > 200) {
            messageHandler.Show("לא ניתן להזמין תור");
            return;
        }

        var duration = getActiveDuration();

        $('#txtTimeFrom').val(s.format("HH:mm"));

        var e = s.add(parseInt(duration), 'minutes');// moment(InfoObj.end);//.add(-3, 'hours');
               

        $('#txtTimeTo').val(e.format("HH:mm"));

        //$('#ddlEvent').val("0");


        if (info.event == null) {

            btnDeleteQue.style.display = "none";
            currentCustomerName
        }

        else {

            var titleArr = InfoObj.title.split(' ');

            if (titleArr.length > 1) {

                var qType = titleArr[0];

                var qCustomer = "";

                for (var j = 1; j < titleArr.length; j++)

                    qCustomer += titleArr[j] + ' ';

                qCustomer = qCustomer.trim();

                var qTypeId = findEventByName(UserData.Activities, qType);
                if (qTypeId != null)
                    $('#ddlEvent').val(qTypeId.Id);

                currentCustomerName = qCustomer;
                $("#spnEventMsg").text(" ל" + currentCustomerName);                
            }
            else {
                var qTypeId = findEventByName(currentUserForCustomer.Activities, InfoObj.title);
                $('#ddlEvent').val(qTypeId.Id);
            }

            btnDeleteQue.style.display = "";

        }
        if (!UserData.isUser) {
            $('#txtTimeFrom').attr("disabled", "disabled");
            $('#txtTimeTo').attr("disabled", "disabled");
        }
        else {
            $('#txtTimeFrom').removeAttr("disabled");
            $('#txtTimeTo').removeAttr("disabled");
        }

        $("#dvEventName").html($("#ddlEvent :selected").text());
        $('#createEventModal').modal('show');
        

    }

    $("#next").click(function () {
        todayX = moment(todayX).add(1, 'days').format('YYYY-MM-DD');
        $('#datetimepicker1').val(moment(todayX).format('DD/MM/YYYY'));
        CheckDatePicker(document.getElementById("datetimepicker1"));

    });



    $("#prev").click(function () {

        todayX = moment(todayX).add(-1, 'days').format('YYYY-MM-DD');
        $('#datetimepicker1').val(moment(todayX).format('DD/MM/YYYY'));
        CheckDatePicker(document.getElementById("datetimepicker1"));


    });



    $("#today").click(function () {

        calendar.today();

    });



    function AddQue() {

        var eventId = $('#ddlEvent').val();

        var employeeId = $('#ddlActivity').val();

        var txtFrom = $("#txtTimeFrom").val();

        var txtTo = $("#txtTimeTo").val();

        if (eventId == null || eventId == 0) {

            showTooltip('ddlEventErr', "נא לבחור תור");

            return;
        }

        if (txtFrom.length <= 0) {

            showTooltip('txtTimeFrom', "נא להזין שעה");

            return;

        }

        if (!isHour(txtFrom)) {

            showTooltip('txtTimeFrom', "נא להזין שעה תקינה");

            return;

        }

        if (txtTo.length <= 0) {

            showTooltip('txtTimeTo', "נא להזין שעה");

            return;

        }

        if (!isHour(txtTo)) {

            showTooltip('txtTimeTo', "נא להזין שעה תקינה");

            return;

        }

        var QueObj = {

            UserId: UserData.isUser ? UserData.UserId : $('#ddlUsers').val(),

            guid: UserData.guid,

            FromDate: currentDate + txtFrom + ":00",

            ToDate: currentDate + txtTo + ":00",

            isUser: UserData.isUser,

            CustomerId: UserData.isUser ? $('#ddlCustomers').val() : UserData.CustomerId,

            QueType: eventId,
            EmployeeId: employeeId

        };



        $.ajax({

            url: "Que/AddCustomerQue",

            type: 'POST',

            data: JSON.stringify(QueObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data == "") {
                    sessionStorage.setItem("LastView", LastView);
                    GetQue(UserData, currentUserDetails, LastView);
                    calendar.gotoDate(todayX);
                    $('#createEventModal').modal('hide');

                }

                else

                    showTooltip('ddlEventErr', data);

            },

            error: function (request, status, error) {

            }

        });
    }

    function findCustomerId() {

        for (var i = 0; i < customersList.length; i++) {

            if (customersList[i].Name === currentCustomerName) {

                return customersList[i].Id;

            }

        }

        return -1;

    }

    function findEventByName(Activities, name) {
        for (var i = 0; i < Activities.length; i++) {
            if (Activities[i].Name == name)
                return Activities[i];
        }
        return null;
    }


    function DeleteQue() {

        var obj = calendar.getEventById(currentId);

        var eventName = $('#ddlEvent').val();

        var txtFrom = $("#txtTimeFrom").val();

        var txtTo = $("#txtTimeTo").val();

        var custId = UserData.isUser ? findCustomerId() : UserData.CustomerId;

        var empId = $('#ddlActivity').val();

        if (custId < 0) {

            return;

        }


        var QueObj = {

            UserId: UserData.isUser ? UserData.UserId : $('#ddlUsers').val(),

            guid: UserData.guid,

            FromDate: currentDate + txtFrom,

            ToDate: currentDate + txtTo,

            isUser: UserData.isUser,

            CustomerId: custId,

            QueTime: 10,

            QueType: eventName,

            EmployeeId: empId

        };



        $.ajax({

            url: "Que/DeleteCustomerQue",

            type: 'POST',

            data: JSON.stringify(QueObj),

            contentType: "application/json;charset=utf-8",

            success: function (data) {

                if (data == "") {

                    GetQue(UserData, currentUserDetails, LastView);

                    $('#createEventModal').modal('hide');

                }

                else

                    showTooltip('ddlEventErr', data);

            },

            error: function (request, status, error) {



            }

        });

    }

    function addEventToCal(eventName, txtFrom, txtTo) {

        var item = { title: eventName, start: todayX + "T" + txtFrom.value + "", end: todayX + "T" + txtTo.value + "" };

        //data.push(item);

        var ev = calendar.getEventById(currentId);

        ev.remove(currentId);



        calendar.addEvent({

            id: currentId,

            title: eventName,

            start: todayX + "T" + txtFrom.value + "",

            end: todayX + "T" + txtTo.value + "",

            editable: true,

            color: '#fff'

        });

        $('#createEventModal').modal('hide');

    }

    function SetCustomer() {

        getCities(function (data) {
            //selectizeService.InitSelectize("ddlCity", 'Id', 'Name', null, data, null);
            $('#ddlCity').selectize({

                valueField: 'Id',

                labelField: 'Name',

                searchField: 'Name',

                options: data,

                create: false,
                onChange: function (value) {
                    if (!isPageLoad) {
                        var $select = $('#ddlUsers').selectize();
                        var control = $select[0].selectize;
                        control.clear();
                        control.clearOptions();

                    }
                    isPageLoad = false;
                }


            });
        });


        $('#ddlUsers').selectize({

            valueField: 'Id',

            labelField: 'User',

            searchField: 'User',

            options: [],

            create: false,
            onChange: function (value) {
                // get user default activities
                var UserSearch = { Id: value, guid: UserData.guid }

                $.ajax({

                    url: "User/GetUserById",

                    type: 'POST',

                    data: JSON.stringify(UserSearch),

                    contentType: "application/json;charset=utf-8",

                    success: function (data) {

                        if (data != null && data.dicBizType != null) {
                            currentUserForCustomer = data;
                            setUser(data);
                            //CheckTodayAvailable(data.dicBizType, data.day);

                        }

                        else {

                            if (data.ErrorMsg != "")

                                showTooltip('ddlUsers', data.ErrorMsg);

                            else

                                showTooltip('ddlUsers', "ארעה שגיאה");

                        }

                    },

                    error: function (request, status, error) {



                    }

                });

            },

            load: function (query, callback) {

                var city = $('#ddlCity').val();

                if (city == "") {

                    showTooltip("dvddlCity", "נא להזין עיר")

                    return;

                }

                if (query.length < 3) return;

                var data = {

                    User: query,

                    tel: "",

                    Adrress: "",

                    City: city,

                    guid: UserData.guid
                }



                $.ajax({

                    url: 'User/GetUsers',

                    type: 'POST',

                    contentType: "application/json;charset=utf-8",

                    data: JSON.stringify(data),



                    error: function () {

                        callback();

                    },

                    success: function (result) {

                        callback(result.usersList);

                    }

                });

            }

        });

    }



    function CheckAvailability() {

        var user = $('#ddlUsers').val();

        if (user == "") {

            showTooltip('dvddlUserers', 'נא להזין שם עסק')

            return;

        }

        UserData.UserId = user;

        GetQue(UserData, null);

    }
    function navigateTo(url) {
        sessionStorage.setItem("remember_me", "1");
        var v = sessionStorage.getItem("version");
        location.href = url + "?ver=" + v;
    }

    //prevent go back
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
    }
</script>